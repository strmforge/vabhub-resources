name: VabHub Resources CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate configuration files
      run: |
        # Validate YAML files
        if [ -d "config/" ] && [ "$(ls -A config/)" ]; then
          find config/ -name "*.yaml" -exec python -c "import yaml; yaml.safe_load(open('{}'))" \;
          find config/ -name "*.yml" -exec python -c "import yaml; yaml.safe_load(open('{}'))" \;
        fi
        
        # Validate JSON files
        find . -name "*.json" -exec python -c "import json; json.load(open('{}'))" \; 2>/dev/null || echo "No JSON files found"
    
    - name: Validate Kubernetes manifests
      run: |
        kubectl apply --dry-run=client -f kubernetes/ --validate=false || echo "Kubernetes validation skipped, no cluster available"

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for secrets in configuration
      uses: gitleaks/gitleaks-action@v2
    
    - name: Validate resource scripts
      run: |
        find scripts/ -name "*.sh" -exec bash -n {} \;

  package:
    runs-on: ubuntu-latest
    needs: [validate, security]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create resource package
      run: |
        mkdir -p dist
        tar -czf dist/vabhub-resources-$(date +%Y%m%d).tar.gz config/ data/ scripts/ kubernetes/
    
    - name: Upload resource artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vabhub-resources-package
        path: dist/